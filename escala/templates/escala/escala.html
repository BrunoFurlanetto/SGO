{% extends 'base.html' %}
{% load static %}
{% include 'parciais/_head.html' %}

{% block conteudo %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}"> <!-- Styles da bootstrap -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}"> <!-- Styles da bootstrap -->

    <div class="conteudo-escala">
        <div id="calendar" class="card" style="padding: 10px"></div>
        {% csrf_token %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                let calendarUI = document.getElementById('calendar');
                let calendar = new FullCalendar.Calendar(calendarUI, {

                    headerToolbar: {
                        left: '',
                        center: 'title',
                    },
                    eventOrderStrict: true,
                    locale: 'pt-br',
                    dayMaxEvents: 3,
                    fixedWeekCount: false,

                    {% if edita %}
                        navLinks: true,
                        navLinkDayClick: function (date, jsEvent) {
                            $("#ModalCadastro").modal('show');
                            escalados = []

                            $.ajax({
                                headers: {"X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()},
                                type: 'GET',
                                url: '',
                                data: {'data_selecionada': date.toLocaleDateString('pt-BR')},
                                success: function (response) {
                                    let professores_disponiveis = response['disponiveis']
                                    let selects_professores = $('.professores-disponiveis')
                                    let lista_disponiveis = $('.disponiveis')

                                    selects_professores.empty().append(`<option></option>`)
                                    lista_disponiveis.empty()
                                    $('#mensagem_erro').empty()

                                    for (let i in professores_disponiveis) {
                                        lista_disponiveis.append('<li>' + professores_disponiveis[i]['nome'] + '</li>');
                                        selects_professores.append(`<option value="${professores_disponiveis[i]['id']}"> ${professores_disponiveis[i]['nome']} </option>`);
                                    }

                                }
                            });

                            $("#id_data").val(moment(date).format('YYYY-MM-DD'))
                        },

                    {% endif %}

                    events: [
                        {% for escala in escalas %}
                            {% for professor in escala.separar_equipe %}
                                {
                                    title: "{{ forloop.counter }} {{ professor }}",
                                    start: "{{ escala.data_escala | date:'Y-m-d' }}",

                                    {% if user.get_full_name == professor %}
                                        color: '#fcc607',
                                        textColor: 'black'
                                    {% endif %}
                                },
                            {% endfor %}
                        {% endfor %}
                    ]

                });
                calendar.render();
                calendar.setOption('locale', 'pt-br')
            });
        </script>

        <div class="modal fade" id="ModalCadastro" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Cadastro de escala</h5>
                        <button class="x-fechar-modal" data-dismiss="modal">
                            <span aria-hidden="false">&times;</span>
                        </button>
                    </div>
                    <form action="{% url 'escala' %}" method="POST">
                        <div class="modal-body">
                            {% csrf_token %}
                            <div>
                                <b>Professores disponiveis na data selecionada:</b>
                                <ul class="disponiveis"></ul>
                            </div>
                            <hr>
                            <div class="lista-professores">
                                <div id="mensagem_erro"></div>
                                <div class="selecao-professores">
                                    <label for="id_data">Data</label>
                                    <input type="date" id="id_data" name="data_escala" readonly>
                                </div>
                                <div class="selecao-professores">
                                    <label for="id_coordenador">Coordenador</label>
                                    <select class="professores-disponiveis" name="coordenador" id="id_coordenador" onChange="verificarDuplicata(this)"></select>
                                </div>
                                <div class="selecao-professores">
                                    <label for="id_professor_2">Professor 2</label>
                                    <select class="professores-disponiveis" name="professor_2" id="id_professor_2" onChange="verificarDuplicata(this)"></select>
                                </div>
                                <div class="selecao-professores">
                                    <label for="id_professor_3">Professor 3</label>
                                    <select class="professores-disponiveis" name="professor_3" id="id_professor_3" onChange="verificarDuplicata(this)"></select>
                                </div>
                                <div class="selecao-professores">
                                    <label for="id_professor_4">Professor 4</label>
                                    <select class="professores-disponiveis" name="professor_4" id="id_professor_4" onChange="verificarDuplicata(this)"></select>
                                </div>
                                <div class="selecao-professores">
                                    <label for="id_professor_5">Professor 5</label>
                                    <select class="professores-disponiveis" name="professor_5" id="id_professor_5" onChange="verificarDuplicata(this)"> </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Salvar escala</button>
                        </div>
                    </form>
                </div>
            </div>
            <script src="{% static 'js/bootstrap.min.js' %}"></script><!-- Script para o calendário da escala -->
        </div>

    </div>

    <script src="{% static 'js/Moment.js' %}"></script>
    <script src="{% static 'js/Moment_timezone.js' %}"></script>
    <script src="{% static 'fullcalendar/main.js' %}"></script><!-- Script para o calendário da escala -->
    <script src="{% static 'js/script_base.js' %}"></script>
{% endblock %}

