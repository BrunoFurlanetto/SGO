{% extends 'base.html' %}
{% load static %}
{% include 'parciais/_head.html' %}

{% block conteudo %}
    <div class="conteudo-detector">
        <div class="titulo-resumo-ceu" style="text-align: center">
            <h2>DETECTOR DE BOMBAS</h2>
        </div>
        <hr>
        <div>
            {% if detectores is not None %}
                <section id="detectores_salvos">
                    <table id="tabela_detectores_salvos" class="table table-bordered table-striped table-hover" style="caption-side: top">
                        <caption>Tabela de detectores de bomba salvos até a data de hoje.</caption>
                        <thead style="border-bottom: solid 1px; text-align: center">
                            <tr class="table-active">
                                <th style="width: 145px">Data inicio</th>
                                <th style="width: 145px">Data final</th>
                                <th>Grupos</th>
                                {% if 'Coordenador pedagógico' in grupos %}
                                    <th style="width: 10px"></th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% if not detectores %}
                                <tr><td colspan="3">Sem detectores salvos até a data de hoje</td></tr>
                            {% endif %}

                            {% for detector in detectores %}
                                <tr>
                                    <td>{{ detector.data_inicio|date:'d F Y' }}</td>
                                    <td>{{ detector.data_final|date:'d F Y' }}</td>
                                    <td>
                                        <button style="border: none; background: transparent" id="{{ detector.id }}" onclick="mostrar_detector(this)">
                                            {{ detector.mostrar_grupos }}
                                        </button>
                                    </td>
                                    {% if 'Coordenador pedagógico' in grupos %}
                                        <td>
                                            <button type="button" id="editar_detector_{{ detector.id }}" class="btn-edit" onclick="edtar_detector(this)"><i class='bx bxs-edit-alt'></i></button>
                                            <button type="button" id="excluir_detector_{{ detector.id }}" class="btn btn-close" onclick="excluir_detector(this)"></button>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <hr>
                    {% if 'Coordenador pedagógico' in grupos %}
                        <div id="div_bt_adicionar">
                            <label for="btn_adicionar_detector" style="margin-top: -5px">Adicionar novo detector</label>
                            <button type="button" class="buton-plus-" id="btn_adicionar_detector" onclick="novo_detector()"><i class='bx bx-plus'></i></button>
                        </div>
                    {% endif %}
                </section>
            {% endif %}

            <section id="pesquisa_evento" {% if detectores is not None %} class="none" {% endif %}>
                <form action="{% url 'detector' %}" method="GET">
                    <fieldset>
                        {% csrf_token %}
                        <div class="row">
                            {% if editar %}
                                <input type="hidden" id="id_detector" value="{{ id_detector }}">
                                <div class="datas" style="width: 32%">
                                    <label for="id_data_inicio">Data início</label>
                                    <input type="date" id="id_data_inicio" name="data_inicio"  value="{{ data_inicio }}" required readonly>
                                </div>
                                <div class="datas" style="width: 32%">
                                    <label for="id_data_final">Data final</label>
                                    <input type="date" id="id_data_final" name="data_final" value="{{ data_final }}" required readonly>
                                </div>
                            {% else %}
                                <div class="datas" style="width: 32%">
                                    <label for="id_data_inicio">Data início</label>
                                    <input type="date" id="id_data_inicio" name="data_inicio"  value="{{ request.GET.data_inicio }}" required>
                                </div>
                                <div class="datas" style="width: 32%">
                                    <label for="id_data_final">Data final</label>
                                    <input type="date" id="id_data_final" name="data_final" value="{{ request.GET.data_final }}" required>
                                </div>
                                <div class="div-botao" style="width: 10%">
                                    <button type="submit" class="buton-search">
                                        <span><i class='bx bx-search'></i></span>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </fieldset>
                </form>

                {% if pesquisado or editar%}
                    <hr>
                    <div class="grupos row">
                        <div style="width: 65%">
                            <div>
                                <label for="clientes">Grupos:</label>
                            </div>
                            <div>
                                {% if editar %}
                                    <select name="clientes" id="clientes" multiple readonly="">
                                        {% for evento in eventos %}
                                            <option value="{{ evento.id }}" selected>{{ evento.nome_fantasia }}</option>
                                        {% endfor %}
                                    </select>
                                    <script>
                                        setTimeout(() => {
                                            pegar_dados_eventos(true)
                                        }, 1)
                                    </script>
                                {% else %}
                                    <select name="clientes" id="clientes" multiple>
                                        {% for evento in eventos %}
                                            <option value="{{ evento.ficha_de_evento.cliente.id }}">{{ evento.instituicao }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </div>
                        </div>

                        {% if not editar %}
                            <div class="div-btn-scan">
                                <button type="button" class="btn btn-scan" onclick="pegar_dados_eventos()"><i class='bx bx-scan'></i></button>
                            </div>
                        {% endif %}

                    </div>
                    {% if not editar %}
                        <div>
                            <input class="form-check-input" type="checkbox" id="select_all" onclick="selecionar_tudo()">
                            <label for="select_all" style="margin-top: 5px">Selecionar todos</label>
                        </div>
                    {% endif %}

                    {% if editar %}
                        <script>$('#clientes').select2({disabled:'readonly'})</script>
                    {% else %}
                        <script>$('#clientes').select2()</script>
                    {% endif %}
                {% endif %}
                <hr>
            </section>

            <section id="detector_de_bombas"></section>

            <section class="escala-por-atividades none">
                <hr>
                <h5 class="titulo-secao" style="text-align: center">Escala para as atividades</h5>
                <form action="{% url 'detector' %}" method="POST">
                    {% csrf_token %}
                    <fieldset id="formulario-escala-professores-atividades"></fieldset>
                </form>
            </section>

        </div>
    </div>

    <div class="modal fade" id="modal-excluir-detector" tabindex="-1" role="dialog" aria-labelledby="TituloModalCentralizado" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="TituloModalCentralizado">Tem certeza disso?</h5>
                    <button type="button" class="close x-fechar-modal" data-dismiss="modal" aria-label="Fechar">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="{% url 'detector' %}" method="POST">
                    <div class="modal-body">
                        <p>Você tem certeza que deseja excluir o detector em questão?</p>
                        {% csrf_token %}
                        <input type="hidden" id="id_detector_excluir" name="detector_excluir">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">Sim</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" aria-label="Fechar">Não</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{% static 'fullcalendar/lib/main.js' %}"></script><!-- Script para o calendário da escala -->
    <script src="{% static 'js/script_detector_de_bombas.js' %}"></script><!-- Script do calendário -->
    <script src="{% static 'js/Moment.js' %}"></script>
    <script src="{% static 'js/Moment_with_locales.js' %}"></script>
    <script src="{% static 'js/Moment_timezone.js' %}"></script>
{% endblock %}