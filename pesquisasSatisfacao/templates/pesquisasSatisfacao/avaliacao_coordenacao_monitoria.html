{% extends 'base.html' %}
{% load custom_filter_tags_avaliacao %}
{% load static %}
{% include 'parciais/_head.html' %}

{% block conteudo %}
    <link rel="stylesheet" href="{% static 'css/style_avaliacao_coordenacao_monitoria.css' %}">
    <div class="container py-5">
        <div class="row justify-content-center w-75">
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h2 class="h4 mb-0">Pesquisa de Satisfação</h2>
                        <p class="mb-0">Avaliação da equipe de monitoria</p>
                    </div>

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="card-body">
                            <!-- Seção 1: Informações Fixas -->
                            <section class="mb-5 text-center">
                                <h3 class="h5 mb-3 text-primary">Informações Gerais</h3>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>Coordenador:</strong></p>
                                        <p>{{ request.user.get_full_name }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>Data do Evento:</strong></p>
                                        <p>{{ ordem.check_in | date:'d/m/Y' }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>Responsável:</strong></p>
                                        <p>{{ ordem.responsavel_grupo }}</p>
                                    </div>
                                    <div>
                                        <p class="mb-1"><strong>Cliente:</strong></p>
                                        <p>{{ ordem.instituicao }}</p>
                                    </div>

                                </div>
                            </section>

                            <!-- Seção 2: Avaliações Individuais -->
                            <section class="mb-5">
                                <h3 class="h5 mb-3 text-primary">Avaliação individual dos Monitores</h3>
                                {{ avaliacao_formset.management_form }}
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>Monitor</th>
                                        <th>Avaliação</th>
                                        <th>Observações</th>
                                    </tr>
                                    </thead>
                                    <tbody id="avaliacoes-container">
                                    {% for form in avaliacao_formset %}
                                        <tr class="avaliacao-item">
                                            <td>
                                                {{ form.instance.usuario.get_full_name }}
                                                <!-- Mostra o nome do monitor -->
                                                {{ form.monitor.as_hidden }}  <!-- Campo hidden com o ID do monitor -->
                                            </td>
                                            <td>
                                                {{ form.avaliacao }}
                                                {% if form.avaliacao.errors %}
                                                    <div class="text-danger">{{ form.avaliacao.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.observacao }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </section>

                            <!-- Seção 3: Destaques -->
                            <section class="mb-5">
                                <h3 class="h5 mb-3 text-primary">Monitores Destaques</h3>
                                <!-- Destaque em Atividades -->
                                <div class="mb-4">
                                    <h4 class="h6 mb-3">Destaque em Atividades (ordene do 1º ao último)</h4>
                                    <div id="destaque-formset-container">
                                        {{ destaque_formset.management_form }}
                                        <table class="table">
                                            <thead>
                                            <tr>
                                                <th>Monitor</th>
                                                <th>Posição</th>
                                                <th></th>
                                            </tr>
                                            </thead>
                                            <tbody id="destaque-container">
                                            {% for form in destaque_formset %}
                                                <tr class="destaque-item">
                                                    <td>
                                                        {{ form.monitor }}  <!-- Campo hidden com o ID do monitor -->
                                                    </td>
                                                    <td>
                                                        <span>{{ forloop.counter }}º</span>
                                                        {{ form.posicao.as_hidden }}
                                                    </td>
                                                    <td>
                                                        {% if forloop.last and not forloop.first %}
                                                            <!-- Só mostra botão no último item -->
                                                            <button type="button"
                                                                    class="bg-transparent border-0 fs-3 remove-item">
                                                                <i class='bx bx-user-x bx-flip-horizontal'></i>
                                                            </button>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-destaque">
                                        <i class="bi bi-plus-circle"></i> Adicionar Destaque
                                    </button>
                                </div>
                            </section>

                            <!-- Seção 4: Avaliação Geral -->
                            <section class="mb-5">
                                <h3 class="h5 mb-3 text-primary">Avaliação Geral da Equipe de Monitoria</h3>
                                {% for field in form.hidden_fields %}
                                    {{ field }}
                                {% endfor %}
                                <table id="tabela-avaliacao-geral" class="form-table">
                                    <thead class="text-center">
                                    <tr class="border-top border-dark">
                                        <th>Pergunta</th>
                                        <th>Observações</th>
                                    </tr>
                                    <tr class="mensagem-observacoes text-danger border-bottom border-dark">
                                        <th colspan="2" class="p-2">EM CASO DE RESPOSTAS "NÃO" OU "REGULAR" OU "RUIM" É
                                            OBRIGATÓRIO PREENCHER O CAMPO DE OBSERVAÇÃO!
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for field in form.visible_fields %}
                                        {% if field.name not in 'observacoes_equipe, palavras_descricao, palavra_1, palavra_2m palavra_3, palavra_4, palavra_5' %}
                                            {% if not field.name|slice:'-3:' == 'obs' %}
                                                <tr data-has-obs="true">
                                                    <!-- Coluna da Pergunta -->
                                                    <td class="pergunta-cell">
                                                        <div class="mb-3">
                                                            {{ field.label_tag }}
                                                            {{ field }}
                                                            {% if field.help_text %}
                                                                <small class="form-text text-muted">{{ field.help_text }}</small>
                                                            {% endif %}
                                                            {% for error in field.errors %}
                                                                <div class="invalid-feedback d-block">
                                                                    {{ error }}
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </td>

                                                    <!-- Coluna da Observação -->
                                                    <td class="obs-cell {% if field.value in "False, 2, 1" %}obs-obrigatoria{% endif %}">                                                        {% with obs_field=form|get_obs_field:field.name %}
                                                            {% if obs_field %}
                                                                <div class="mb-3 mt-3">
                                                                    {{ obs_field }}
                                                                    {% for error in obs_field.errors %}
                                                                        <div class="invalid-feedback d-block">
                                                                            {{ error }}
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </section>

                            <!-- Seção 5: Observações Finais -->
                            <h3 class="h5 mb-3 text-primary">Observações gerais</h3>
                            <div class="mb-3">
                                {{ form.observacoes_equipe.label_tag }}
                                {{ form.observacoes_equipe }}
                                {% if form.observacoes_equipe.help_text %}
                                    <small class="form-text text-muted">{{ form.observacoes_equipe.help_text }}</small>
                                {% endif %}
                                {% for error in form.observacoes_equipe.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ error }}
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="palavras-chave-container mb-4">
                                <label class="form-label">Palavras-chave (máx. 5):</label>
                                <div class="row g-2">
                                    {% for i in "12345" %}
                                        <div class="col-md-4 col-6">
                                            <input type="text"
                                                   name="palavra_{{ i }}"
                                                   id="id_palavra_{{ i }}"
                                                   class="form-control palavra-chave-input"
                                                   maxlength="20"
                                                   value="{{ form.instance.palavras_descricao|default:''|slice:forloop.counter0|first|default:'' }}"
                                                   placeholder="Palavra {{ i }}"
                                                   data-index="{{ forloop.counter0 }}">
                                        </div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">Digite até 5 palavras-chave individuais</small>
                            </div>
                        </div>

                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="history.back()">
                                    <i class="bi bi-arrow-left"></i> Voltar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Enviar Pesquisa
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/scripts_coordenador_monitoria.js' %}"></script>
{% endblock %}
