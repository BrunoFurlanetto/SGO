{% extends 'base.html' %}
{% load static %}
{% include 'parciais/_head.html' %}

{% block conteudo %}
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h4 mb-0">Pesquisa de Satisfação</h2>
                        <p class="mb-0">Coordenação avaliando Monitoria</p>
                    </div>

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="card-body">
                            <!-- Seção 1: Informações Fixas -->
                            <section class="mb-5">
                                <h3 class="h5 mb-3 text-primary">Informações Gerais</h3>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Coordenador:</strong></p>
                                        <p>{{ request.user.get_full_name }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Data do Evento:</strong></p>
                                        <p>{% now "SHORT_DATE_FORMAT" %}</p>
                                    </div>
                                </div>
                            </section>

                            <!-- Seção de Avaliações Individuais -->
                            <h3 class="h5 mb-3 text-primary">Avaliação dos Monitores</h3>
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>Monitor</th>
                                    <th>Avaliação</th>
                                    <th>Observações</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for form in avaliacao_formset %}
                                    <tr>
                                        <!-- Nome do Monitor (somente leitura) -->
                                        <td>
                                            {{ form.monitor.value|default:form.instance.monitor }}
                                            {{ form.monitor.as_hidden }}  <!-- Campo oculto com o ID -->
                                        </td>

                                        <!-- Campo de Avaliação -->
                                        <td>
                                            {{ form.avaliacao }}
                                            {% if form.avaliacao.errors %}
                                                <div class="text-danger">
                                                    {{ form.avaliacao.errors }}
                                                </div>
                                            {% endif %}
                                        </td>

                                        <!-- Campo de Observações -->
                                        <td>
                                            {{ form.observacao }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>

                            {{ avaliacao_formset.management_form }}

                            <!-- Seção 3: Destaques -->
                            <section class="mb-5">
                                <h3 class="h5 mb-3 text-primary">Monitores Destaques</h3>
                                <div class="mb-4">
                                    <h4 class="h6 mb-3">Destaque em Atividades (ordene do 1º ao último)</h4>
                                    {{ destaque_formset.management_form }}
                                    {% for form in destaque_formset %}
                                        <div class="destaque-item mb-3 p-3 border rounded">
                                            <div class="row g-2 align-items-center">
                                                <div class="col-md-7">
                                                    {{ form.monitor }}
                                                </div>
                                                <div class="col-md-3">
                                                    {{ form.posicao }}
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-danger remove-item">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2"
                                            id="add-destaque">
                                        <i class="bi bi-plus-circle"></i> Adicionar Destaque
                                    </button>
                                </div>
                            </section>

                            <!-- Seção 4: Avaliação Geral -->
                            <section class="mb-5">
                                <h3 class="h5 mb-3 text-primary">Avaliação Geral</h3>
                                {% for field in form %}
                                    {% if field.name not in excluded_fields %}
                                        <div class="mb-3">
                                            {{ field.label_tag }}
                                            {% if field.field.widget.input_type == 'checkbox' %}
                                                <div class="form-check">
                                                    {{ field }}
                                                    <label class="form-check-label"
                                                           for="{{ field.id_for_label }}"></label>
                                                </div>
                                            {% else %}
                                                {{ field }}
                                            {% endif %}
                                            {% if field.help_text %}
                                                <small class="form-text text-muted">{{ field.help_text }}</small>
                                            {% endif %}
                                            {% for error in field.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </section>

                            <!-- Seção 5: Observações Finais -->
                            <section class="mb-4">
                                <div class="form-floating">
                                        <textarea class="form-control" id="observacoes_gerais" name="observacoes_gerais"
                                                  style="height: 100px"></textarea>
                                    <label for="observacoes_gerais">Observações Gerais</label>
                                </div>
                            </section>
                        </div>

                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="history.back()">
                                    <i class="bi bi-arrow-left"></i> Voltar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Enviar Pesquisa
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Dinâmica para adicionar avaliações
            document.getElementById('add-avaliacao').addEventListener('click', function () {
                const totalForms = document.getElementById('id_avaliacaoindividualmonitor_set-TOTAL_FORMS');
                const container = document.getElementById('avaliacoes-container');
                const newForm = container.querySelector('.avaliacao-item').cloneNode(true);
                const formRegex = /avaliacaoindividualmonitor_set-(\d+)-/g;
                const formIdx = parseInt(totalForms.value);

                newForm.innerHTML = newForm.innerHTML.replace(formRegex, `avaliacaoindividualmonitor_set-${formIdx}-`);
                container.appendChild(newForm);
                totalForms.value = formIdx + 1;

                // Limpa os valores do novo form
                newForm.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.type !== 'hidden') el.value = '';
                });
            });

            // Dinâmica para adicionar destaques
            document.getElementById('add-destaque').addEventListener('click', function () {
                const totalForms = document.getElementById('id_destaqueatividades_set-TOTAL_FORMS');
                const container = document.querySelector('#destaque-formset-container');
                const newForm = container.querySelector('.destaque-item').cloneNode(true);
                const formRegex = /destaqueatividades_set-(\d+)-/g;
                const formIdx = parseInt(totalForms.value);

                newForm.innerHTML = newForm.innerHTML.replace(formRegex, `destaqueatividades_set-${formIdx}-`);
                container.appendChild(newForm);
                totalForms.value = formIdx + 1;

                // Limpa os valores do novo form
                newForm.querySelectorAll('input, select').forEach(el => {
                    if (el.type !== 'hidden') el.value = '';
                });
            });

            // Remover itens
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function () {
                    this.closest('.destaque-item').remove();
                });
            });

            // Validação em tempo real para campos que requerem observação
            document.querySelectorAll('[id$="-avaliacao"]').forEach(select => {
                select.addEventListener('change', function () {
                    const obsField = this.closest('.avaliacao-item').querySelector('[id$="-observacao"]');
                    if (['1', '2'].includes(this.value)) {
                        obsField.required = true;
                        obsField.closest('.form-group').classList.add('required-field');
                    } else {
                        obsField.required = false;
                        obsField.closest('.form-group').classList.remove('required-field');
                    }
                });
            });
        });
    </script>
{% endblock %}
